系统配置
========

.. _configuration:

服务配置
--------

API服务的配置文件默认在/etc/auditlog/auditlog.conf文件中。
主要包括API服务地址配置、数据库连接配置、认证配置、日志配置。
常用的配置信息见下表，完整的配置信息可以查看etc/auditlog/auditlog.conf。

[DEFAULT]
`````````

==========                                ==========      =============================
配置项                                    初始值          说明
==========                                ==========      =============================
debug                                     false           布尔值，是否输出调试信息
verbose                                   false           布尔值，是否输出详细日志
use_stderr                                true            布尔值，是否输出日志到标准报错
==========                                ==========      =============================

[api]
`````

========== ========= ==========================================
配置项      初始值    说明
========== ========= ==========================================
host        0.0.0.0   字符串，auditlog API服务的监听IP
port        8800      整数值，auditlog API服务的监听端口
========== ========= ==========================================

.. _database_config:

[database]
``````````

====================== =================================== ==========================================
配置项                  初始值                             说明
====================== =================================== ==========================================
auditlog_connection     mongodb://localhost:27017/auditlog 字符串，数据库连接字符串
====================== =================================== ==========================================

[keystone_authtoken]
````````````````````
================= ========= ======================================
配置项             初始值    说明
================= ========= ======================================
auth_host         127.0.0.1 字符串，提供认证API服务的主机
auth_port         35357     整数，认证服务的端口
auth_protocol     https     字符串，认证服务的协议（http或者https）
admin_user        None      字符串，keystone账号用户名
admin_password    None      字符串，keystone账号密码
admin_tenant_name admin     字符串，keystone账号所属租户名称
================= ========= ======================================

日志采集配置
------------

目前，用户行为日志是通过WSGI应用的中间件（middleware）来实现的，并存储到数据库中，因此这部分相关的配置主要是中间件配置和数据库连接配置两部分。

中间件配置
``````````

首先需要将审计日志中间件插入到API服务的pipeline中，如果服务是使用 `paste <http://pythonpaste.org/>`_ 管理，可以编辑paste配置文件，增加中间件及其配置，以下以修改nova的配置文件/etc/nova/api-paste.ini为例，说明配置过程。

1. 增加过滤器及其配置

   将以下内容添加到配置文件，增加审计日志过滤器。

::

    [filter:auditlog]
    paste.filter_factory = auditlog.middleware:AuditMiddleware.factory
    audit_methods = POST, PUT, DELETE

2. 添加过滤器到paste管道

   修改[composite:openstack_compute_api_v2]、[composite:openstack_compute_api_v3]配置节的keystone_nolimit、keystone管道配置，在行尾追加auditlog过滤器。

数据库连接
``````````

目前中间件直接连接统一的数据库存储操作日志，因此需要在每个API服务的配置文件（一般是服务名称.conf文件）中的[database]节添加数据库的连接字符串，具体配置项参见 :ref:`database_config` 。
